<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mining Unit Breakdown Monitor</title>
  <style>
    /* ... styles as before ... */
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: #f4f7fa;
      color: #333;
    }
    header {
      background: #004d40;
      color: #fff;
      padding: 1.5rem 2rem;
      text-align: center;
      font-size: 1.6rem;
      letter-spacing: 1px;
      font-weight: 700;
      box-shadow: 0 3px 5px rgba(0,0,0,0.2);
    }
    main {
      max-width: 960px;
      margin: 2rem auto 4rem;
      background: #fff;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }
    h2 {
      color: #00695c;
      margin-bottom: 1rem;
    }
    form {
      display: grid;
      gap: 1.2rem;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      margin-bottom: 2rem;
    }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 0.4rem;
    }
    input, select, textarea, button {
      font-family: inherit;
      font-size: 1rem;
    }
    input, select, textarea {
      width: 100%;
      padding: 0.5rem 0.7rem;
      border: 1.8px solid #90a4ae;
      border-radius: 6px;
      transition: border-color 0.25s ease;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #004d40;
      outline: none;
    }
    button {
      background: #00796b;
      color: #fff;
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: 7px;
      cursor: pointer;
      justify-self: start;
      transition: background-color 0.3s ease;
    }
    button:hover:not(:disabled) {
      background: #004d40;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    section.breakdown-section {
      margin-top: 1rem;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.6rem 0.8rem;
      border-bottom: 1px solid #ddd;
      text-align: left;
      vertical-align: middle;
    }
    th {
      background-color: #004d40;
      color: white;
      position: sticky;
      top: 0;
    }
    .no-data {
      padding: 1rem;
      text-align: center;
      font-style: italic;
      color: #777;
    }
    .spare-parts-container, .pic-container {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 0.7rem;
      background: #fafafa;
      max-height: 180px;
      overflow-y: auto;
    }
    .item-row {
      display: grid;
      grid-template-columns: 1fr 100px 80px 30px;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.4rem;
    }
    .pic-item-row {
      display: grid;
      grid-template-columns: 1fr 30px;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.4rem;
    }
    .item-row input,
    .item-row select,
    .pic-item-row select {
      font-size: 0.9rem;
      padding: 0.3rem 0.4rem;
    }
    .item-row button,
    .pic-item-row button {
      background: #e53935;
      border: none;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      padding: 0 0.5rem;
      font-size: 1.1rem;
      line-height: 1;
    }
    .add-item-btn {
      background: #00796b;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      margin-top: 0.4rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    .add-item-btn:hover {
      background: #004d40;
    }
    .editable-row {
      cursor: pointer;
    }
    .editable-row:hover {
      background-color: #f5f5f5;
    }
    .edit-mode {
      background-color: #e8f5e8 !important;
    }
    @media(max-width: 900px) {
      form {
        grid-template-columns: 1fr;
      }
      table th:nth-child(6), table td:nth-child(6),
      table th:nth-child(7), table td:nth-child(7),
      table th:nth-child(8), table td:nth-child(8),
      table th:nth-child(9), table td:nth-child(9),
      table th:nth-child(10), table td:nth-child(10),
      table th:nth-child(11), table td:nth-child(11) {
        display: none;
      }
    }
  </style>
</head>
<body>

<header>
  Monitor Breakdown Detail Unit Tambang Batu Bara
</header>

<main>
  <section class="breakdown-section" aria-label="Input Detail Breakdown Unit">
    <h2>Input Detail Breakdown Unit</h2>
    <form id="breakdown-form">
      <div>
        <label for="woNumber">No WO</label>
        <input type="text" id="woNumberInput" name="woNumber" placeholder="Nomor Work Order" required />
      </div>
      <div>
        <label for="unitCodeSelect">Unit Code</label>
        <select id="unitCodeSelect" name="unitCodeSelect" required>
          <option value="" disabled selected>Pilih Unit</option>
        </select>
      </div>
      <div>
        <label for="breakdownDate">Tanggal Breakdown</label>
        <input type="date" id="breakdownDateInput" name="breakdownDate" required />
      </div>
      <div>
        <label for="breakdownTime">Jam Breakdown (waktu laporan)</label>
        <input type="time" id="breakdownTimeInput" name="breakdownTime" required />
      </div>
      <div>
        <label for="componentSelect">Komponen</label>
        <select id="componentSelect" name="componentSelect" required>
          <option value="" disabled selected>Pilih Komponen</option>
          <option value="Engine">Mesin (Engine)</option>
          <option value="Hydraulic System">Sistem Hidrolik</option>
          <option value="Electrical System">Sistem Elektrikal</option>
          <option value="Transmission">Transmisi</option>
          <option value="Undercarriage">Undercarriage</option>
          <option value="Cooling System">Sistem Pendingin</option>
          <option value="Fuel System">Sistem Bahan Bakar</option>
          <option value="Operator Cabin">Kabin Operator</option>
          <option value="Other">Lainnya</option>
        </select>
      </div>
      <div>
        <label for="subcomponentSelect">Sub Komponen</label>
        <select id="subcomponentSelect" name="subcomponentSelect" required>
          <option value="" disabled selected>Pilih Sub Komponen</option>
        </select>
      </div>
      <div style="grid-column: 1 / -1;">
        <label for="breakdownDesc">Deskripsi Kerusakan</label>
        <textarea id="breakdownDescInput" name="breakdownDesc" rows="3" placeholder="Jelaskan penyebab dan efek breakdown..." required></textarea>
      </div>
      <div style="grid-column: 1 / -1;">
        <label for="repairIssue">Kendala Perbaikan</label>
        <textarea id="repairIssueInput" name="repairIssue" rows="3" placeholder="Jelaskan kendala saat perbaikan..." required></textarea>
      </div>
      <div style="grid-column: 1 / -1;">
        <label>PIC / Person In Charge</label>
        <div id="picContainer" class="pic-container" aria-live="polite" aria-relevant="additions removals"></div>
        <button type="button" id="addPicBtn" class="add-item-btn" aria-label="Tambah PIC">+ Tambah PIC</button>
      </div>
      <div style="grid-column: 1 / -1;">
        <label>Spare Parts yang Dipasang</label>
        <div id="sparePartsContainer" class="spare-parts-container" aria-live="polite" aria-relevant="additions removals"></div>
        <button type="button" id="addSparePartBtn" class="add-item-btn" aria-label="Tambah spare part">+ Tambah Spare Part</button>
      </div>
      <div style="grid-column: 1 / -1; justify-self: start;">
        <button type="submit" id="submitBtn">Tambah Breakdown</button>
      </div>
    </form>

    <div aria-live="polite" aria-atomic="true" aria-relevant="text" style="margin-top:1rem;">
      <h3>Daftar Breakdown <small style="color: #666; font-size: 0.8em;">(Double-click untuk edit)</small></h3>
      <table id="breakdownTable" aria-describedby="breakdownDesc">
        <thead>
          <tr>
            <th>No WO</th>
            <th>Unit Code</th>
            <th>Tanggal</th>
            <th>Jam Breakdown</th>
            <th>Status Case</th>
            <th>Close Date</th>
            <th>Close Time</th>
            <th>Komponen</th>
            <th>Sub Komponen</th>
            <th>Deskripsi</th>
            <th>Kendala Perbaikan</th>
            <th>PIC</th>
            <th>Spare Parts Dipasang</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="breakdownTbody">
          <tr><td colspan="14" class="no-data">Belum ada data breakdown</td></tr>
        </tbody>
      </table>
    </div>
  </section>
</main>

<script>
// === CONFIGURE THIS SECTION ===
const GOOGLE_API_KEY = "AIzaSyBSR4tOOHllYLG3hf5AAtmXiyeMRPsUtMI"; // <-- your API key
const GOOGLE_SHEET_ID = "10R3Wv9iDX0TxuflsCzcAvQlmKAPDY5UqAbw1B5gQfnY";      // <-- your Google Sheets ID
const UNIT_CODE_RANGE = "UnitList!A2:A";      // <-- range where unit codes are stored, adjust as needed

// Optionally: set your PIC and spare part data here
const picDatabase = ['Nando', 'Fajar', 'Rizal', 'Arief'];
const sparePartsDatabase = [
  {name: 'Filter Oli'},
  {name: 'Seal Kit Cylinder'},
  {name: 'Fan Belt'},
  {name: 'Relay Starter'},
  {name: 'Injector'},
  {name: 'Alternator'},
  {name: 'Hydraulic Pump'}
];
const unitOptions = ['pcs','set','unit'];

const subcomponentsMap = {
  'Engine': ['Fuel Injector', 'Turbocharger', 'Oil Pump'],
  'Hydraulic System': ['Pump', 'Cylinder', 'Valve'],
  'Electrical System': ['Alternator', 'Battery', 'Starter'],
  'Transmission': ['Gearbox', 'Clutch', 'Torque Converter'],
  'Undercarriage': ['Track Chain', 'Sprocket', 'Roller'],
  'Cooling System': ['Radiator', 'Coolant Pump', 'Fan'],
  'Fuel System': ['Fuel Pump', 'Fuel Line', 'Injector'],
  'Operator Cabin': ['AC', 'Control Panel', 'Seat'],
  'Other': ['Lainnya']
};

// === Populate Unit Code from Google Sheets ===
async function populateUnitCodesFromSheet() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}/values/${encodeURIComponent(UNIT_CODE_RANGE)}?key=${GOOGLE_API_KEY}`;
  try {
    const response = await fetch(url);
    const data = await response.json();
    const unitCodeSelect = document.getElementById('unitCodeSelect');
    // Remove all existing options except the first
    unitCodeSelect.length = 1;
    if (data.values && data.values.length > 0) {
      data.values.forEach(row => {
        const code = row[0];
        if(code) {
          const option = document.createElement('option');
          option.value = code;
          option.textContent = code;
          unitCodeSelect.appendChild(option);
        }
      });
    }
  } catch (err) {
    console.error('Error fetching unit codes:', err);
  }
}
populateUnitCodesFromSheet();

// === PIC logic ===
function createPicSelect(id) {
  const select = document.createElement('select');
  select.name = `picName_${id}`;
  select.required = true;
  select.setAttribute('aria-label', 'Pilih PIC');
  const defaultOpt = document.createElement('option');
  defaultOpt.value = '';
  defaultOpt.disabled = true;
  defaultOpt.selected = true;
  defaultOpt.textContent = 'Pilih PIC';
  select.appendChild(defaultOpt);
  picDatabase.forEach(name => {
    let opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    select.appendChild(opt);
  });
  return select;
}
function createPicRow(id) {
  const row = document.createElement('div');
  row.className = 'pic-item-row';
  row.dataset.id = id;

  const select = createPicSelect(id);

  const removeBtn = document.createElement('button');
  removeBtn.type = 'button';
  removeBtn.setAttribute('aria-label', 'Hapus PIC');
  removeBtn.textContent = '✕';
  removeBtn.addEventListener('click', () => {
    row.remove();
  });

  row.appendChild(select);
  row.appendChild(removeBtn);
  return row;
}
let picIdCounter = 0;
function addPicRow() {
  picIdCounter++;
  let row = createPicRow(picIdCounter);
  document.getElementById('picContainer').appendChild(row);
}
document.getElementById('addPicBtn').addEventListener('click', addPicRow);
addPicRow();

// === Spare Part logic ===
function createUnitSelect(id) {
  const select = document.createElement('select');
  select.name = `sparePartUnit_${id}`;
  select.required = true;
  select.setAttribute('aria-label', 'Pilih Satuan');
  unitOptions.forEach(unit => {
    let opt = document.createElement('option');
    opt.value = unit;
    opt.textContent = unit;
    if (unit === 'pcs') opt.selected = true;
    select.appendChild(opt);
  });
  return select;
}
function createSparePartSelect(id) {
  const select = document.createElement('select');
  select.name = `sparePartName_${id}`;
  select.required = true;
  select.setAttribute('aria-label', 'Pilih Spare Part');
  const defaultOpt = document.createElement('option');
  defaultOpt.value = '';
  defaultOpt.disabled = true;
  defaultOpt.selected = true;
  defaultOpt.textContent = 'Pilih Spare Part';
  select.appendChild(defaultOpt);
  sparePartsDatabase.forEach(part => {
    let opt = document.createElement('option');
    opt.value = part.name;
    opt.textContent = part.name;
    select.appendChild(opt);
  });
  return select;
}
function createSparePartRow(id) {
  const row = document.createElement('div');
  row.className = 'item-row';
  row.dataset.id = id;

  const select = createSparePartSelect(id);

  const qtyInput = document.createElement('input');
  qtyInput.type = 'number';
  qtyInput.name = `sparePartQty_${id}`;
  qtyInput.min = 1;
  qtyInput.value = 1;
  qtyInput.required = true;
  qtyInput.setAttribute('aria-label', 'Jumlah Spare Part');
  qtyInput.style.textAlign = 'center';

  const unitSelect = createUnitSelect(id);

  const removeBtn = document.createElement('button');
  removeBtn.type = 'button';
  removeBtn.setAttribute('aria-label', 'Hapus spare part');
  removeBtn.textContent = '✕';
  removeBtn.addEventListener('click', () => {
    row.remove();
  });

  row.appendChild(select);
  row.appendChild(qtyInput);
  row.appendChild(unitSelect);
  row.appendChild(removeBtn);
  return row;
}
let sparePartIdCounter = 0;
function addSparePartRow() {
  sparePartIdCounter++;
  const row = createSparePartRow(sparePartIdCounter);
  document.getElementById('sparePartsContainer').appendChild(row);
}
document.getElementById('addSparePartBtn').addEventListener('click', addSparePartRow);
addSparePartRow();

// === Subcomponent dynamic ===
const componentSelect = document.getElementById('componentSelect');
const subcomponentSelect = document.getElementById('subcomponentSelect');
function updateSubcomponents() {
  const selectedComp = componentSelect.value;
  subcomponentSelect.innerHTML = '<option value="" disabled selected>Pilih Sub Komponen</option>';
  if (subcomponentsMap[selectedComp]) {
    subcomponentsMap[selectedComp].forEach(subc => {
      const opt = document.createElement('option');
      opt.value = subc;
      opt.textContent = subc;
      subcomponentSelect.appendChild(opt);
    });
  }
  subcomponentSelect.disabled = !selectedComp;
}
componentSelect.addEventListener('change', updateSubcomponents);
subcomponentSelect.disabled = true;

// === Get form values helpers ===
function getPicsFromForm() {
  const pics = [];
  const rows = document.getElementById('picContainer').querySelectorAll('.pic-item-row');
  for (let row of rows) {
    const select = row.querySelector('select');
    if (select && select.value) {
      pics.push(select.value);
    }
  }
  return pics;
}
function getSparePartsFromForm() {
  const parts = [];
  const rows = document.getElementById('sparePartsContainer').querySelectorAll('.item-row');
  for (let row of rows) {
    const selects = row.querySelectorAll('select');
    const qtyInput = row.querySelector('input[type="number"]');
    const nameSelect = selects[0];
    const unitSelect = selects[1];
    if (nameSelect && nameSelect.value && qtyInput && unitSelect) {
      parts.push({
        name: nameSelect.value,
        qty: parseInt(qtyInput.value),
        unit: unitSelect.value
      });
    }
  }
  return parts;
}
function clearPicContainer() {
  document.getElementById('picContainer').innerHTML = '';
  picIdCounter = 0;
  addPicRow();
}
function clearSparePartsContainer() {
  document.getElementById('sparePartsContainer').innerHTML = '';
  sparePartIdCounter = 0;
  addSparePartRow();
}

// === Form and Table State ===
let breakdownEntries = [];
let editingIndex = -1;

// --- Populate form for editing ---
function populateFormForEdit(entry) {
  document.getElementById('woNumberInput').value = entry.woNumber;
  document.getElementById('unitCodeSelect').value = entry.unitCode;
  document.getElementById('breakdownDateInput').value = entry.date;
  document.getElementById('breakdownTimeInput').value = entry.breakdownTime;
  document.getElementById('componentSelect').value = entry.component;
  updateSubcomponents();
  setTimeout(() => {
    document.getElementById('subcomponentSelect').value = entry.subcomponent;
  }, 100);
  document.getElementById('breakdownDescInput').value = entry.description;
  document.getElementById('repairIssueInput').value = entry.repairIssue;
  clearPicContainer();
  entry.pics.forEach(pic => {
    addPicRow();
    const lastRow = document.getElementById('picContainer').lastElementChild;
    const select = lastRow.querySelector('select');
    select.value = pic;
  });
  clearSparePartsContainer();
  entry.spareParts.forEach(part => {
    addSparePartRow();
    const lastRow = document.getElementById('sparePartsContainer').lastElementChild;
    const selects = lastRow.querySelectorAll('select');
    const qtyInput = lastRow.querySelector('input[type="number"]');
    const nameSelect = selects[0];
    const unitSelect = selects[1];
    nameSelect.value = part.name;
    qtyInput.value = part.qty;
    unitSelect.value = part.unit;
  });
  document.getElementById('submitBtn').textContent = 'Update Breakdown';
}

// --- Reset form to default state ---
function resetForm() {
  document.getElementById('breakdown-form').reset();
  clearPicContainer();
  clearSparePartsContainer();
  subcomponentSelect.innerHTML = '<option value="" disabled selected>Pilih Sub Komponen</option>';
  subcomponentSelect.disabled = true;
  document.getElementById('submitBtn').textContent = 'Tambah Breakdown';
  editingIndex = -1;
}

// --- Add or update breakdown ---
function addBreakdownEntry(entry) {
  if (editingIndex >= 0) {
    breakdownEntries[editingIndex] = entry;
    editingIndex = -1;
  } else {
    breakdownEntries.push(entry);
  }
  renderBreakdownTable();
}

// --- Table render ---
function renderBreakdownTable() {
  const breakdownTbody = document.getElementById('breakdownTbody');
  if (breakdownEntries.length === 0) {
    breakdownTbody.innerHTML = `<tr><td colspan="14" class="no-data">Belum ada data breakdown</td></tr>`;
    return;
  }
  breakdownTbody.innerHTML = breakdownEntries.map((entry, index) => {
    const picsStr = entry.pics.length ? entry.pics.join(', ') : '-';
    const spareParts = entry.spareParts || [];
    let sparePartsHtml = spareParts.length ? spareParts.map(p => `<div>${p.name} (${p.qty} ${p.unit})</div>`).join('') : '-';
    return `<tr class="editable-row" data-index="${index}">
      <td>${entry.woNumber}</td>
      <td>${entry.unitCode}</td>
      <td>${entry.date}</td>
      <td>${entry.breakdownTime}</td>
      <td>${entry.caseStatus}</td>
      <td>${entry.closeDate || "-"}</td>
      <td>${entry.closeTime || "-"}</td>
      <td>${entry.component}</td>
      <td>${entry.subcomponent}</td>
      <td>${entry.description}</td>
      <td>${entry.repairIssue}</td>
      <td>${picsStr}</td>
      <td>${sparePartsHtml}</td>
      <td>
        <button aria-label="Close case WO ${entry.woNumber}" class="close-case-btn" data-index="${index}"${entry.caseStatus === 'Closed' ? ' disabled' : ''}>${entry.caseStatus === 'Closed' ? 'Case Closed' : 'Close Case'}</button>
        <button aria-label="Hapus breakdown pada WO ${entry.woNumber}" data-index="${index}" class="delete-btn" style="background:#e53935;color:white;border:none;padding:0.3rem 0.7rem;border-radius:5px;cursor:pointer;margin-left:0.3rem;">Hapus</button>
      </td>
    </tr>`;
  }).join('');
}

// --- Form submit handler ---
document.getElementById('breakdown-form').addEventListener('submit', e => {
  e.preventDefault();

  const woNumber = document.getElementById('woNumberInput').value.trim();
  const unitCode = document.getElementById('unitCodeSelect').value;
  const date = document.getElementById('breakdownDateInput').value;
  const breakdownTime = document.getElementById('breakdownTimeInput').value;
  const component = document.getElementById('componentSelect').value;
  const subcomponent = document.getElementById('subcomponentSelect').value;
  const description = document.getElementById('breakdownDescInput').value.trim();
  const repairIssue = document.getElementById('repairIssueInput').value.trim();
  const pics = getPicsFromForm();
  const spareParts = getSparePartsFromForm();

  if (!woNumber || !unitCode || !date || !breakdownTime || !component || !subcomponent || !description || !repairIssue) {
    alert('Mohon lengkapi semua field yang diperlukan.');
    return;
  }
  if (pics.length === 0) {
    alert('Mohon tambahkan minimal satu PIC.');
    return;
  }

  let caseStatus = editingIndex >= 0 ? breakdownEntries[editingIndex].caseStatus : 'Open';
  let closeDate = editingIndex >= 0 ? breakdownEntries[editingIndex].closeDate : undefined;
  let closeTime = editingIndex >= 0 ? breakdownEntries[editingIndex].closeTime : undefined;

  const newEntry = { woNumber, unitCode, date, breakdownTime, caseStatus, closeDate, closeTime, component, subcomponent, description, repairIssue, pics, spareParts };
  addBreakdownEntry(newEntry);
  resetForm();
  alert(editingIndex >= 0 ? 'Data breakdown berhasil diupdate!' : 'Data breakdown berhasil ditambahkan!');
});

// --- Double-click row to edit ---
document.getElementById('breakdownTbody').addEventListener('dblclick', e => {
  const row = e.target.closest('tr.editable-row');
  if (row) {
    const index = parseInt(row.getAttribute('data-index'));
    if (!isNaN(index)) {
      editingIndex = index;
      populateFormForEdit(breakdownEntries[index]);
      document.getElementById('breakdown-form').scrollIntoView({ behavior: 'smooth' });
    }
  }
});

// --- Row action buttons (delete/close) ---
document.getElementById('breakdownTbody').addEventListener('click', e => {
  if (e.target.classList.contains('delete-btn')) {
    const index = parseInt(e.target.getAttribute('data-index'));
    if (!isNaN(index)) {
      if (confirm('Yakin ingin menghapus data breakdown ini?')) {
        breakdownEntries.splice(index, 1);
        renderBreakdownTable();
        if (editingIndex === index) {
          resetForm();
        }
      }
    }
  }
  else if (e.target.classList.contains('close-case-btn')) {
  const index = parseInt(e.target.getAttribute('data-index'));
  if (!isNaN(index)) {
    // TAMBAHKAN KONFIRMASI RFU
    const isRFU = confirm('Apakah unit sudah RFU (Ready For Use)?');
    if (!isRFU) {
      // Jika user klik "Batal", proses close tidak dijalankan
      return;
    }
    // Lanjutkan proses close seperti biasa
    const now = new Date();
    const pad = num => num.toString().padStart(2, '0');
    const today = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
    const time = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
    breakdownEntries[index].caseStatus = "Closed";
    breakdownEntries[index].closeDate = today;
    breakdownEntries[index].closeTime = time;
    renderBreakdownTable();
    }
  }
});

renderBreakdownTable();
</script>

</body>
</html>
