<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unit Breakdown Monitor</title>
  <!-- SheetJS for Excel Export -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: linear-gradient(120deg, #e0f2f1 0%, #ffffff 100%);
      color: #333;
      min-height: 100vh;
    }
    header {
      background: linear-gradient(90deg, #004d40 60%, #26a69a 100%);
      color: #fff;
      padding: 2rem 2rem 1.5rem;
      text-align: center;
      font-size: 2rem;
      letter-spacing: 2px;
      font-weight: 700;
      box-shadow: 0 3px 12px rgba(0,0,0,0.08);
      border-bottom-left-radius: 35px;
      border-bottom-right-radius: 35px;
    }
    main {
      max-width: 1100px;
      margin: 2.5rem auto 4rem;
      background: #fff;
      padding: 2.5rem 2rem 2rem 2rem;
      border-radius: 18px;
      box-shadow: 0 12px 40px 0 rgba(16, 110, 97, 0.12);
    }
    h2 {
      color: #00796b;
      margin-bottom: 1rem;
      letter-spacing: 1px;
    }
    form {
      display: grid;
      gap: 1.3rem;
      grid-template-columns: repeat(auto-fit,minmax(240px,1fr));
      margin-bottom: 2rem;
      background: #f8fafb;
      border-radius: 9px;
      padding: 1.5rem 1rem 1rem 1rem;
      box-shadow: 0 1px 6px rgba(0,0,0,0.05);
    }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 0.35rem;
      color: #00332d;
      letter-spacing: 0.2px;
    }
    input, select, textarea, button {
      font-family: inherit;
      font-size: 1rem;
    }
    input, select, textarea {
      width: 100%;
      padding: 0.56rem 0.8rem;
      border: 1.7px solid #93b1ad;
      border-radius: 7px;
      transition: border-color 0.22s ease;
      background: #f4f7fa;
      color: #263238;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #00796b;
      outline: none;
      background: #e0f2f1;
    }
    button {
      background: linear-gradient(90deg,#009688 60%,#004d40 100%);
      color: #fff;
      border: none;
      padding: 0.8rem 1.8rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 1px 3px rgba(0,0,0,0.07);
      transition: background 0.23s;
    }
    button:hover:not(:disabled) {
      background: linear-gradient(90deg,#004d40 80%,#009688 100%);
      color: #fff;
      box-shadow: 0 2px 10px rgba(0,77,64,0.10);
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    .breakdown-section {
      margin-top: 1rem;
    }
    .table-container {
      background: #f8fafb;
      border-radius: 11px;
      box-shadow: 0 1px 8px rgba(0,0,0,0.06);
      padding: 1.5rem 1rem 1rem;
      margin-top: 2rem;
    }
    table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      margin-top: 1rem;
      background: #fff;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 1px 6px rgba(0,77,64,0.07);
    }
    th, td {
      padding: 0.7rem 0.8rem;
      border-bottom: 1px solid #e0e4e3;
      text-align: left;
      vertical-align: top;
      font-size: 0.98rem;
    }
    th {
      background: linear-gradient(90deg, #004d40 80%, #009688 100%);
      color: white;
      font-weight: 600;
      border-bottom: 3px solid #26a69a;
      position: sticky;
      top: 0;
      z-index: 1;
      letter-spacing: 0.5px;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .no-data {
      padding: 1rem;
      text-align: center;
      font-style: italic;
      color: #888;
      background: #fcfcfc;
    }
    .spare-parts-container, .pic-container {
      border: 1px solid #cce5e0;
      border-radius: 7px;
      padding: 0.8rem;
      background: #f1f7f6;
      max-height: 180px;
      overflow-y: auto;
      margin-bottom: 0.4rem;
    }
    .item-row {
      display: grid;
      grid-template-columns: 2.5fr 1fr 1fr 40px;
      gap: 0.6rem;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .pic-item-row {
      display: grid;
      grid-template-columns: 2.5fr 40px;
      gap: 0.6rem;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .item-row input,
    .item-row select,
    .pic-item-row select {
      font-size: 0.96rem;
      padding: 0.32rem 0.5rem;
    }
    .item-row button,
    .pic-item-row button {
      background: #e53935;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      padding: 0 0.6rem;
      font-size: 1.22rem;
      line-height: 1;
      transition: background 0.18s;
    }
    .item-row button:hover,
    .pic-item-row button:hover {
      background: #c62828;
    }
    .add-item-btn {
      background: #009688;
      color: white;
      border: none;
      padding: 0.5rem 1.2rem;
      margin-top: 0.3rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.23s;
    }
    .add-item-btn:hover {
      background: #004d40;
    }
    .editable-row {
      cursor: pointer;
      transition: background 0.15s;
    }
    .editable-row:hover {
      background-color: #f5faf8;
    }
    .edit-mode {
      background-color: #e8f5e8 !important;
    }
    .table-action-btn {
      margin-right: 0.3em;
      font-size: 0.98rem;
      padding: 0.38em 1.1em;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.18s;
    }
    .close-case-btn {
      background: #388e3c;
      color: #fff;
    }
    .close-case-btn:disabled {
      background: #bdbdbd;
      color: #eee;
      cursor: not-allowed;
    }
    .delete-btn {
      background: #e53935;
      color: #fff;
    }
    .export-btn {
      display: inline-block;
      background: linear-gradient(90deg,#ffb300 70%,#ffa000 100%);
      color: #263238;
      font-weight: 600;
      border: none;
      border-radius: 7px;
      padding: 0.7rem 1.7rem;
      margin-bottom: 1.2em;
      margin-top: 1.3em;
      font-size: 1.05rem;
      letter-spacing: 0.5px;
      box-shadow: 0 1px 4px rgba(255,193,7,0.10);
      cursor: pointer;
      transition: background 0.18s;
    }
    .export-btn:hover {
      background: linear-gradient(90deg,#ffa000 80%,#ffb300 100%);
      color: #111;
    }
    @media (max-width: 900px) {
      form { grid-template-columns: 1fr; }
      th, td { font-size: 0.97rem; }
      table th:nth-child(6), table td:nth-child(6),
      table th:nth-child(7), table td:nth-child(7),
      table th:nth-child(8), table td:nth-child(8),
      table th:nth-child(9), table td:nth-child(9),
      table th:nth-child(10), table td:nth-child(10),
      table th:nth-child(11), table td:nth-child(11) {
        display: none;
      }
    }
    @media (max-width: 600px) {
      main { padding: 1rem 0.1rem; }
      .table-container { padding: 1rem 0.2rem 0.5rem; }
      th, td { padding: 0.45rem 0.5rem; }
    }
  </style>
</head>
<body>

<header>
  Monitor Breakdown Detail Unit
</header>

<main>
  <section class="breakdown-section" aria-label="Input Detail Breakdown Unit">
    <h2>Input Detail Breakdown Unit</h2>
    <form id="breakdown-form">
      <div>
        <label for="woNumber">No WO</label>
        <input type="text" id="woNumberInput" name="woNumber" placeholder="Nomor Work Order" required />
      </div>
      <div>
        <label for="unitCodeSelect">Unit Code</label>
        <select id="unitCodeSelect" name="unitCodeSelect" required>
          <option value="" disabled selected>Pilih Unit</option>
        </select>
      </div>
      <div>
        <label for="breakdownDate">Tanggal Breakdown</label>
        <input type="date" id="breakdownDateInput" name="breakdownDate" required />
      </div>
      <div>
        <label for="breakdownTime">Jam Breakdown (waktu laporan)</label>
        <input type="time" id="breakdownTimeInput" name="breakdownTime" required />
      </div>
      <div>
        <label for="componentSelect">Komponen</label>
        <select id="componentSelect" name="componentSelect" required>
          <option value="" disabled selected>Pilih Komponen</option>
          <option value="Engine">Mesin (Engine)</option>
          <option value="Hydraulic System">Sistem Hidrolik</option>
          <option value="Electrical System">Sistem Elektrikal</option>
          <option value="Transmission">Transmisi</option>
          <option value="Undercarriage">Undercarriage</option>
          <option value="Cooling System">Sistem Pendingin</option>
          <option value="Fuel System">Sistem Bahan Bakar</option>
          <option value="Operator Cabin">Kabin Operator</option>
          <option value="Other">Lainnya</option>
        </select>
      </div>
      <div>
        <label for="subcomponentSelect">Sub Komponen</label>
        <select id="subcomponentSelect" name="subcomponentSelect" required>
          <option value="" disabled selected>Pilih Sub Komponen</option>
        </select>
      </div>
      <div style="grid-column: 1 / -1;">
        <label for="breakdownDesc">Deskripsi Kerusakan</label>
        <textarea id="breakdownDescInput" name="breakdownDesc" rows="3" placeholder="Jelaskan penyebab dan efek breakdown..." required></textarea>
      </div>
      <div style="grid-column: 1 / -1;">
        <label for="repairIssue">Kendala Perbaikan</label>
        <textarea id="repairIssueInput" name="repairIssue" rows="3" placeholder="Jelaskan kendala saat perbaikan..." required></textarea>
      </div>
      <div style="grid-column: 1 / -1;">
        <label>PIC / Person In Charge</label>
        <div id="picContainer" class="pic-container" aria-live="polite" aria-relevant="additions removals"></div>
        <button type="button" id="addPicBtn" class="add-item-btn" aria-label="Tambah PIC">+ Tambah PIC</button>
      </div>
      <div style="grid-column: 1 / -1;">
        <label>Spare Parts yang Dipasang</label>
        <div id="sparePartsContainer" class="spare-parts-container" aria-live="polite" aria-relevant="additions removals"></div>
        <button type="button" id="addSparePartBtn" class="add-item-btn" aria-label="Tambah spare part">+ Tambah Spare Part</button>
      </div>
      <div style="grid-column: 1 / -1; justify-self: start;">
        <button type="submit" id="submitBtn">Tambah Breakdown</button>
      </div>
    </form>

    <div class="table-container" aria-live="polite" aria-atomic="true" aria-relevant="text">
      <h3 style="margin-bottom:0.2em;">Daftar Breakdown 
        <small style="color: #666; font-size: 0.8em;">(Double-click untuk edit)</small>
      </h3>
      <button id="exportExcelBtn" class="export-btn">Export to Excel (.xlsx)</button>
      <table id="breakdownTable" aria-describedby="breakdownDesc">
        <thead>
          <tr>
            <th style="min-width:70px">No WO</th>
            <th style="min-width:90px">Unit Code</th>
            <th style="min-width:100px">Tanggal</th>
            <th style="min-width:90px">Jam Breakdown</th>
            <th style="min-width:110px">Status Case</th>
            <th style="min-width:100px">Close Date</th>
            <th style="min-width:90px">Close Time</th>
            <th style="min-width:110px">Komponen</th>
            <th style="min-width:130px">Sub Komponen</th>
            <th style="min-width:180px">Deskripsi</th>
            <th style="min-width:160px">Kendala Perbaikan</th>
            <th style="min-width:100px">PIC</th>
            <th style="min-width:160px">Spare Parts Dipasang</th>
            <th style="min-width:120px">Aksi</th>
          </tr>
        </thead>
        <tbody id="breakdownTbody">
          <tr><td colspan="14" class="no-data">Belum ada data breakdown</td></tr>
        </tbody>
      </table>
    </div>
  </section>
</main>

<script>
// --- Konfigurasi ---
const GOOGLE_API_KEY = "AIzaSyALiUj7DgbZ9I-0J6iMDCnUFMUvxzvjOco";
const GOOGLE_SHEET_ID = "13jfu8544tZfAHqSYUL2aPWX2KhPzSvM9ZvOk-XGP7AI";
const UNIT_CODE_RANGE = "UnitList!A2:A";
const BREAKDOWN_DATA_RANGE = "Breakdown!A2:M"; // Sesuaikan dgn range sheet breakdown
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxHRIONJ-eOz-e7rFyvAlYgTcHrCLuEzaER0G3R1sjiU7AKWN1t9ElZcuUzay43VTA/exec"; // Ganti dengan URL Web App Google Apps Script Anda

const picDatabase = ['Nando', 'Fajar', 'Rizal', 'Arief'];
const sparePartsDatabase = [
  {name: 'Filter Oli'},
  {name: 'Seal Kit Cylinder'},
  {name: 'Fan Belt'},
  {name: 'Relay Starter'},
  {name: 'Injector'},
  {name: 'Alternator'},
  {name: 'Hydraulic Pump'}
];
const unitOptions = ['pcs','set','unit'];
const subcomponentsMap = {
  'Engine': ['Fuel Injector', 'Turbocharger', 'Oil Pump'],
  'Hydraulic System': ['Pump', 'Cylinder', 'Valve'],
  'Electrical System': ['Alternator', 'Battery', 'Starter'],
  'Transmission': ['Gearbox', 'Clutch', 'Torque Converter'],
  'Undercarriage': ['Track Chain', 'Sprocket', 'Roller'],
  'Cooling System': ['Radiator', 'Coolant Pump', 'Fan'],
  'Fuel System': ['Fuel Pump', 'Fuel Line', 'Injector'],
  'Operator Cabin': ['AC', 'Control Panel', 'Seat'],
  'Other': ['Lainnya']
};

// --- Populate Unit Code from Google Sheets ---
async function populateUnitCodesFromSheet() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}/values/${encodeURIComponent(UNIT_CODE_RANGE)}?key=${GOOGLE_API_KEY}`;
  try {
    const response = await fetch(url);
    const data = await response.json();
    const unitCodeSelect = document.getElementById('unitCodeSelect');
    unitCodeSelect.length = 1;
    if (data.values && data.values.length > 0) {
      data.values.forEach(row => {
        const code = row[0];
        if(code) {
          const option = document.createElement('option');
          option.value = code;
          option.textContent = code;
          unitCodeSelect.appendChild(option);
        }
      });
    }
  } catch (err) {
    console.error('Error fetching unit codes:', err);
  }
}
populateUnitCodesFromSheet();

// --- PIC logic ---
function createPicSelect(id) {
  const select = document.createElement('select');
  select.name = `picName_${id}`;
  select.required = true;
  select.setAttribute('aria-label', 'Pilih PIC');
  const defaultOpt = document.createElement('option');
  defaultOpt.value = '';
  defaultOpt.disabled = true;
  defaultOpt.selected = true;
  defaultOpt.textContent = 'Pilih PIC';
  select.appendChild(defaultOpt);
  picDatabase.forEach(name => {
    let opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    select.appendChild(opt);
  });
  return select;
}
function createPicRow(id) {
  const row = document.createElement('div');
  row.className = 'pic-item-row';
  row.dataset.id = id;

  const select = createPicSelect(id);

  const removeBtn = document.createElement('button');
  removeBtn.type = 'button';
  removeBtn.setAttribute('aria-label', 'Hapus PIC');
  removeBtn.textContent = '✕';
  removeBtn.addEventListener('click', () => {
    row.remove();
  });

  row.appendChild(select);
  row.appendChild(removeBtn);
  return row;
}
let picIdCounter = 0;
function addPicRow() {
  picIdCounter++;
  let row = createPicRow(picIdCounter);
  document.getElementById('picContainer').appendChild(row);
}
document.getElementById('addPicBtn').addEventListener('click', addPicRow);
addPicRow();

// --- Spare Part logic ---
function createUnitSelect(id) {
  const select = document.createElement('select');
  select.name = `sparePartUnit_${id}`;
  select.required = true;
  select.setAttribute('aria-label', 'Pilih Satuan');
  unitOptions.forEach(unit => {
    let opt = document.createElement('option');
    opt.value = unit;
    opt.textContent = unit;
    if (unit === 'pcs') opt.selected = true;
    select.appendChild(opt);
  });
  return select;
}
function createSparePartSelect(id) {
  const select = document.createElement('select');
  select.name = `sparePartName_${id}`;
  select.required = true;
  select.setAttribute('aria-label', 'Pilih Spare Part');
  const defaultOpt = document.createElement('option');
  defaultOpt.value = '';
  defaultOpt.disabled = true;
  defaultOpt.selected = true;
  defaultOpt.textContent = 'Pilih Spare Part';
  select.appendChild(defaultOpt);
  sparePartsDatabase.forEach(part => {
    let opt = document.createElement('option');
    opt.value = part.name;
    opt.textContent = part.name;
    select.appendChild(opt);
  });
  return select;
}
function createSparePartRow(id) {
  const row = document.createElement('div');
  row.className = 'item-row';
  row.dataset.id = id;

  const select = createSparePartSelect(id);

  const qtyInput = document.createElement('input');
  qtyInput.type = 'number';
  qtyInput.name = `sparePartQty_${id}`;
  qtyInput.min = 1;
  qtyInput.value = 1;
  qtyInput.required = true;
  qtyInput.setAttribute('aria-label', 'Jumlah Spare Part');
  qtyInput.style.textAlign = 'center';

  const unitSelect = createUnitSelect(id);

  const removeBtn = document.createElement('button');
  removeBtn.type = 'button';
  removeBtn.setAttribute('aria-label', 'Hapus spare part');
  removeBtn.textContent = '✕';
  removeBtn.addEventListener('click', () => {
    row.remove();
  });

  row.appendChild(select);
  row.appendChild(qtyInput);
  row.appendChild(unitSelect);
  row.appendChild(removeBtn);
  return row;
}
let sparePartIdCounter = 0;
function addSparePartRow() {
  sparePartIdCounter++;
  const row = createSparePartRow(sparePartIdCounter);
  document.getElementById('sparePartsContainer').appendChild(row);
}
document.getElementById('addSparePartBtn').addEventListener('click', addSparePartRow);
addSparePartRow();

// --- Subcomponent dynamic ---
const componentSelect = document.getElementById('componentSelect');
const subcomponentSelect = document.getElementById('subcomponentSelect');
function updateSubcomponents() {
  const selectedComp = componentSelect.value;
  subcomponentSelect.innerHTML = '<option value="" disabled selected>Pilih Sub Komponen</option>';
  if (subcomponentsMap[selectedComp]) {
    subcomponentsMap[selectedComp].forEach(subc => {
      const opt = document.createElement('option');
      opt.value = subc;
      opt.textContent = subc;
      subcomponentSelect.appendChild(opt);
    });
  }
  subcomponentSelect.disabled = !selectedComp;
}
componentSelect.addEventListener('change', updateSubcomponents);
subcomponentSelect.disabled = true;

// --- Get form values helpers ---
function getPicsFromForm() {
  const pics = [];
  const rows = document.getElementById('picContainer').querySelectorAll('.pic-item-row');
  for (let row of rows) {
    const select = row.querySelector('select');
    if (select && select.value) {
      pics.push(select.value);
    }
  }
  return pics;
}
function getSparePartsFromForm() {
  const parts = [];
  const rows = document.getElementById('sparePartsContainer').querySelectorAll('.item-row');
  for (let row of rows) {
    const selects = row.querySelectorAll('select');
    const qtyInput = row.querySelector('input[type="number"]');
    const nameSelect = selects[0];
    const unitSelect = selects[1];
    if (nameSelect && nameSelect.value && qtyInput && unitSelect) {
      parts.push({
        name: nameSelect.value,
        qty: parseInt(qtyInput.value),
        unit: unitSelect.value
      });
    }
  }
  return parts;
}
function clearPicContainer() {
  document.getElementById('picContainer').innerHTML = '';
  picIdCounter = 0;
  addPicRow();
}
function clearSparePartsContainer() {
  document.getElementById('sparePartsContainer').innerHTML = '';
  sparePartIdCounter = 0;
  addSparePartRow();
}

// --- Form and Table State ---
let breakdownEntries = [];
let editingIndex = -1;

// --- Fetch Data Breakdown from Google Sheets ---
async function fetchBreakdownEntriesFromSheet() {
  const url = "https://script.google.com/macros/s/AKfycbxHRIONJ-eOz-e7rFyvAlYgTcHrCLuEzaER0G3R1sjiU7AKWN1t9ElZcuUzay43VTA/exec";
  try {
    const response = await fetch(url);
    const data = await response.json();
    if (data.values && data.values.length > 0) {
      breakdownEntries = data.values.map(row => ({
        woNumber: row[0] || '',
        unitCode: row[1] || '',
        date: row[2] || '',
        breakdownTime: row[3] || '',
        caseStatus: row[4] || '',
        closeDate: row[5] || '',
        closeTime: row[6] || '',
        component: row[7] || '',
        subcomponent: row[8] || '',
        description: row[9] || '',
        repairIssue: row[10] || '',
        pics: row[11] ? row[11].split(',').map(s=>s.trim()) : [],
        spareParts: row[12] ? JSON.parse(row[12]) : [],
      }));
    } else {
      breakdownEntries = [];
    }
    renderBreakdownTable();
  } catch (err) {
    breakdownEntries = [];
    renderBreakdownTable();
    alert('Gagal mengambil data dari Google Sheets.');
    console.error('Error fetching breakdown entries:', err);
  }
}

// --- Populate form for editing ---
function populateFormForEdit(entry) {
  document.getElementById('woNumberInput').value = entry.woNumber;
  document.getElementById('unitCodeSelect').value = entry.unitCode;
  document.getElementById('breakdownDateInput').value = entry.date;
  document.getElementById('breakdownTimeInput').value = entry.breakdownTime;
  document.getElementById('componentSelect').value = entry.component;
  updateSubcomponents();
  setTimeout(() => {
    document.getElementById('subcomponentSelect').value = entry.subcomponent;
  }, 100);
  document.getElementById('breakdownDescInput').value = entry.description;
  document.getElementById('repairIssueInput').value = entry.repairIssue;
  clearPicContainer();
  entry.pics.forEach(pic => {
    addPicRow();
    const lastRow = document.getElementById('picContainer').lastElementChild;
    const select = lastRow.querySelector('select');
    select.value = pic;
  });
  clearSparePartsContainer();
  entry.spareParts.forEach(part => {
    addSparePartRow();
    const lastRow = document.getElementById('sparePartsContainer').lastElementChild;
    const selects = lastRow.querySelectorAll('select');
    const qtyInput = lastRow.querySelector('input[type="number"]');
    const nameSelect = selects[0];
    const unitSelect = selects[1];
    nameSelect.value = part.name;
    qtyInput.value = part.qty;
    unitSelect.value = part.unit;
  });
  document.getElementById('submitBtn').textContent = 'Update Breakdown';
}

// --- Reset form to default state ---
function resetForm() {
  document.getElementById('breakdown-form').reset();
  clearPicContainer();
  clearSparePartsContainer();
  subcomponentSelect.innerHTML = '<option value="" disabled selected>Pilih Sub Komponen</option>';
  subcomponentSelect.disabled = true;
  document.getElementById('submitBtn').textContent = 'Tambah Breakdown';
  editingIndex = -1;
}

// --- Add or update breakdown (hanya menambah ke Google Sheets via Apps Script) ---
function addBreakdownEntryToSheet(entry) {
  fetch("https://script.google.com/macros/s/AKfycbxHRIONJ-eOz-e7rFyvAlYgTcHrCLuEzaER0G3R1sjiU7AKWN1t9ElZcuUzay43VTA/exec", {
    method: 'POST',
    body: JSON.stringify(entry),
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(res => res.json())
  .then(response => {
    if (response.result === 'success') {
      alert('Data berhasil disimpan ke Google Sheets!');
      fetchBreakdownEntriesFromSheet();
      resetForm();
    } else {
      alert('Gagal menyimpan data!');
    }
  })
  .catch(err => {
    alert('Gagal menghubungi server Apps Script!');
    console.error(err);
  });
}

// --- Table render ---
function renderBreakdownTable() {
  const breakdownTbody = document.getElementById('breakdownTbody');
  if (breakdownEntries.length === 0) {
    breakdownTbody.innerHTML = `<tr><td colspan="14" class="no-data">Belum ada data breakdown</td></tr>`;
    return;
  }
  breakdownTbody.innerHTML = breakdownEntries.map((entry, index) => {
    const picsStr = entry.pics.length ? entry.pics.join(', ') : '-';
    const spareParts = entry.spareParts || [];
    let sparePartsHtml = spareParts.length ? spareParts.map(p => `<div>${p.name} (${p.qty} ${p.unit})</div>`).join('') : '-';
    return `<tr class="editable-row" data-index="${index}">
      <td>${entry.woNumber}</td>
      <td>${entry.unitCode}</td>
      <td>${entry.date}</td>
      <td>${entry.breakdownTime}</td>
      <td>${entry.caseStatus}</td>
      <td>${entry.closeDate || "-"}</td>
      <td>${entry.closeTime || "-"}</td>
      <td>${entry.component}</td>
      <td>${entry.subcomponent}</td>
      <td>${entry.description}</td>
      <td>${entry.repairIssue}</td>
      <td>${picsStr}</td>
      <td>${sparePartsHtml}</td>
      <td>
        <button aria-label="Close case WO ${entry.woNumber}" class="table-action-btn close-case-btn" data-index="${index}"${entry.caseStatus === 'Closed' ? ' disabled' : ''}>${entry.caseStatus === 'Closed' ? 'Case Closed' : 'Close Case'}</button>
        <button aria-label="Hapus breakdown pada WO ${entry.woNumber}" data-index="${index}" class="table-action-btn delete-btn">Hapus</button>
      </td>
    </tr>`;
  }).join('');
}

// --- Form submit handler ---
document.getElementById('breakdown-form').addEventListener('submit', e => {
  e.preventDefault();

  const woNumber = document.getElementById('woNumberInput').value.trim();
  const unitCode = document.getElementById('unitCodeSelect').value;
  const date = document.getElementById('breakdownDateInput').value;
  const breakdownTime = document.getElementById('breakdownTimeInput').value;
  const component = document.getElementById('componentSelect').value;
  const subcomponent = document.getElementById('subcomponentSelect').value;
  const description = document.getElementById('breakdownDescInput').value.trim();
  const repairIssue = document.getElementById('repairIssueInput').value.trim();
  const pics = getPicsFromForm();
  const spareParts = getSparePartsFromForm();

  if (!woNumber || !unitCode || !date || !breakdownTime || !component || !subcomponent || !description || !repairIssue) {
    alert('Mohon lengkapi semua field yang diperlukan.');
    return;
  }
  if (pics.length === 0) {
    alert('Mohon tambahkan minimal satu PIC.');
    return;
  }

  const caseStatus = 'Open';
  const closeDate = '';
  const closeTime = '';

  const newEntry = { woNumber, unitCode, date, breakdownTime, caseStatus, closeDate, closeTime, component, subcomponent, description, repairIssue, pics, spareParts };
  addBreakdownEntryToSheet(newEntry);
});

// --- Double-click row to edit (optional, hanya untuk edit tampilan lokal) ---
document.getElementById('breakdownTbody').addEventListener('dblclick', e => {
  const row = e.target.closest('tr.editable-row');
  if (row) {
    const index = parseInt(row.getAttribute('data-index'));
    if (!isNaN(index)) {
      editingIndex = index;
      populateFormForEdit(breakdownEntries[index]);
      document.getElementById('breakdown-form').scrollIntoView({ behavior: 'smooth' });
    }
  }
});

// --- Row action buttons (delete/close) ---
document.getElementById('breakdownTbody').addEventListener('click', e => {
  if (e.target.classList.contains('delete-btn')) {
    alert('Hapus data hanya bisa dilakukan pada Google Sheets langsung.');
  } else if (e.target.classList.contains('close-case-btn')) {
    alert('Close Case hanya bisa dilakukan pada Google Sheets langsung atau fitur update diaktifkan.');
  }
});


// --- EXPORT TO EXCEL (SheetJS) ---
document.getElementById('exportExcelBtn').addEventListener('click', function () {
  const table = document.getElementById('breakdownTable');
  // Only export visible rows (avoid no-data row)
  let tempTable = table.cloneNode(true);
  let tbody = tempTable.querySelector('tbody');
  // Remove all .no-data rows
  Array.from(tbody.querySelectorAll('.no-data')).forEach(row => row.remove());
  // Remove last column (Aksi)
  Array.from(tempTable.querySelectorAll('tr')).forEach(tr => {
    if (tr.cells.length > 13) tr.deleteCell(13);
  });
  const wb = XLSX.utils.table_to_book(tempTable, {sheet: "Daftar Breakdown"});
  XLSX.writeFile(wb, 'daftar_breakdown_unit.xlsx');
});

// --- Load data saat halaman dibuka ---
fetchBreakdownEntriesFromSheet();

</script>

</body>
</html>
